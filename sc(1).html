<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shortcuts</title>
     <style>
        :root {
            --bg-color: #3d0021;
            --toolbar-color: #1c1c1c;
            --root-sc-color: #ffe11f;
            --subfolder-sc-color: #00ff1e;
            --both-sc-color: #009dff;
            --delete-sc-color: #ff0101;
            --header-text-color: #01ff01;
            --row-number-color: #fcfc01;
            --date-text-color: #01ffff;
        }
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: #ffffff;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        .main-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        .main-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .top-bar {
            padding: 10px;
            border-bottom: 1px solid #444444;
            display: flex;
            align-items: center;
            height: 36px;
            box-sizing: border-box;
            background-color: var(--toolbar-color);
        }
        .bottom-bar {
            padding: 10px;
            border-top: 1px solid #444444;
            display: flex;
            align-items: center;
            height: 36px;
            box-sizing: border-box;
            background-color: var(--toolbar-color);
            color: white;
            justify-content: space-between;
        }
        #thumbnail-container {
            flex-grow: 1;
            padding: 20px;
            position: relative;
            overflow: auto;
            min-width: 0;
        }
        .thumbnail {
            object-fit: cover;
            border-radius: 6px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            cursor: pointer;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 2500;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
            padding-top: 60px;
        }
        .modal-content {
            background-color: #ffffff;
            margin: 5% auto;
            padding: 24px;
            border: none;
            border-radius: 8px;
            width: 90%;
            max-width: 680px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .close {
            color: #606770;
            float: right;
            font-size: 32px;
            font-weight: bold;
        }
        .close:hover,
        .close:focus {
            color: #1c1e21;
            text-decoration: none;
            cursor: pointer;
        }
        #batch-script {
            width: 100%;
            box-sizing: border-box;
            border-radius: 6px;
            border: 1px solid #ccd0d5;
            padding: 8px;
            font-family: "Courier New", Courier, monospace;
            margin-top: 8px;
            margin-bottom: 12px;
            resize: vertical;
        }
        .landscape-row {
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
        }
        .thumbnails-container {
            display: flex;
            flex-wrap: wrap;
            align-items: flex-start;
            position: relative;
        }
        .main-container.show-numbers .thumbnails-container {
            padding-left: 40px;
        }
        .thumbnail.selected-root-sc {
            outline: 3px dashed var(--root-sc-color);
        }
        .thumbnail.selected-subfolder-sc {
            outline: 3px dashed var(--subfolder-sc-color);
        }
        .thumbnail.selected-both-sc {
            outline: 3px dashed var(--both-sc-color);
        }
        .thumbnail.selected-delete-sc {
            outline: 3px dashed var(--delete-sc-color);
        }
        .thumbnail.selected-shortcut {
            outline: 3px dashed green;
        }
        select {
            height: 36px;
            padding: 0 8px 0 8px;
            padding-right: 32px;
            border: 1px solid #444444;
            background-color: var(--toolbar-color);
            color: #ffffff;
            border-radius: 0;
            font-size: 14px;
            box-sizing: border-box;
            margin-right: 10px;
            text-align: center;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 8px center;
            background-size: 16px;
        }
        select option {
            padding: 8px 12px;
            background-color: #ffffff;
            color: #000000;
        }
        .bar-button {
            height: 36px;
            padding: 0 12px;
            border: 1px solid #444444;
            background-color: var(--toolbar-color);
            color: #ffffff;
            border-radius: 0;
            font-size: 14px;
            cursor: pointer;
        }
        .bar-button:hover {
            background-color: #166fe5;
        }
        .selection-type-button.active {
            background-color: rgba(255, 255, 255, 0.2);
            border-color: #ffffff;
        }
        #root-sc-btn.active {
            outline: 3px dashed var(--root-sc-color);
            outline-offset: -3px;
        }
        #subfolder-sc-btn.active {
            outline: 3px dashed var(--subfolder-sc-color);
            outline-offset: -3px;
        }
        #both-sc-btn.active {
            outline: 3px dashed var(--both-sc-color);
            outline-offset: -3px;
        }
        #delete-sc-btn.active {
            outline: 3px dashed var(--delete-sc-color);
            outline-offset: -3px;
        }
        .project-header {
            color: var(--header-text-color);
            font-size: 1.2em;
            font-weight: bold;
            margin-top: 20px;
            margin-bottom: 10px;
            border-bottom: 1px solid #ccc;
            padding-bottom: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .date-info {
            display: none;
            font-size: 0.8em;
            font-weight: normal;
            color: var(--date-text-color);
            margin-bottom: 5px;
        }
        .main-container.show-dates .date-info {
            display: block;
        }
        .main-container.show-numbers .date-info {
            padding-left: 40px;
        }
        .checkbox-container {
            display: flex;
            align-items: center;
            margin-left: 15px;
            color: white;
            font-size: 14px;
        }
        .checkbox-container input {
            margin-right: 5px;
        }
        .row-number {
            font-size: 1.5em;
            font-weight: bold;
            color: var(--row-number-color);
            position: absolute;
            left: 0;
            top: 0;
            width: 30px;
            text-align: right;
        }
        .dropdown-content {
            display: none;
            position: absolute;
            background-color: #ffffff;
            min-width: 450px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 3000;
            top: 100%;
            left: 0;
            border: 1px solid #ccc;
        }
        .dropdown-content button {
            color: black;
            padding: 10px 16px;
            text-decoration: none;
            display: block;
            width: 100%;
            text-align: left;
            border: none;
            background-color: #ffffff;
            cursor: pointer;
            font-size: 14px;
            white-space: nowrap;
        }
        .dropdown-content button:nth-child(even) {
            background-color: #f2f2f2;
        }
        .dropdown-content button:hover {
            background-color: #e2e2e2;
        }
        .dropdown-content .show {
            display: block;
        }
        .options-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 16px;
            color: black;
            font-size: 14px;
        }
        .options-row:nth-child(even) {
            background-color: #f2f2f2;
        }
        .options-row label {
            cursor: pointer;
        }
        .options-row input[type="color"] {
            border: none;
            width: 30px;
            height: 30px;
            cursor: pointer;
            background: none;
        }
        .selection-type-button {
            display: flex;
            align-items: center;
        }
        .color-circle {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
            display: inline-block;
        }
        .playlist-nav-btn {
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            cursor: pointer;
            padding: 5px 10px;
            font-size: 18px;
            border-radius: 4px;
            margin: 0 5px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .playlist-nav-btn:hover {
            background-color: rgba(0, 0, 0, 0.8);
        }
        .playlist-nav-container {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="main-content">
            <div class="top-bar">
                <div id="load-menu-container" style="position: relative; margin-right: 10px;">
                    <button id="load-menu-btn" title="Load" class="bar-button" style="padding: 0 8px; display: flex; align-items: center; justify-content: center;">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: white;"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>
                    </button>
                    <div id="load-dropdown" class="dropdown-content">
                        <button id="load-directory-btn">Load all videos</button>
                        <button id="load-latest-videos-btn">Load new videos</button>
                        <button id="load-sc-btn">Load all shortcuts</button>
                        <button id="load-root-sc-btn">Load root shortcut directory</button>
                        <button id="create-playlist-load-btn">Create playlist</button>
                    </div>
                </div>
                <div id="options-menu-container" style="position: relative; margin-right: 10px;">
                    <button id="options-menu-btn" title="Options" class="bar-button" style="padding: 0 8px; display: flex; align-items: center; justify-content: center;">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: white;">
                            <circle cx="12" cy="12" r="3"></circle>
                            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                        </svg>
                    </button>
                    <div id="options-dropdown" class="dropdown-content">
                        <div class="options-row">
                            <label for="bg-color-picker">Page Background</label>
                            <input type="color" id="bg-color-picker" value="#3d0021">
                        </div>
                        <div class="options-row">
                            <label for="toolbar-color-picker">Toolbars</label>
                            <input type="color" id="toolbar-color-picker" value="#1c1c1c">
                        </div>
                        <div class="options-row">
                            <label for="root-sc-color-picker">Root SC Outline</label>
                            <input type="color" id="root-sc-color-picker" value="#ffe11f">
                        </div>
                        <div class="options-row">
                            <label for="subfolder-sc-color-picker">Subfolder SC Outline</label>
                            <input type="color" id="subfolder-sc-color-picker" value="#00ff1e">
                        </div>
                        <div class="options-row">
                            <label for="both-sc-color-picker">Both SC Outline</label>
                            <input type="color" id="both-sc-color-picker" value="#009dff">
                        </div>
                        <div class="options-row">
                            <label for="delete-sc-color-picker">Delete Selection Outline</label>
                            <input type="color" id="delete-sc-color-picker" value="#ff0101">
                        </div>
                        <div class="options-row">
                            <label for="header-text-color-picker">Folder Header Text</label>
                            <input type="color" id="header-text-color-picker" value="#01ff01">
                        </div>
                        <div class="options-row">
                            <label for="row-number-color-picker">Show Numbers Header Text</label>
                            <input type="color" id="row-number-color-picker" value="#fcfc01">
                        </div>
                        <div class="options-row">
                            <label for="date-text-color-picker">Date Text Color</label>
                            <input type="color" id="date-text-color-picker" value="#01ffff">
                        </div>
                        <button id="revert-defaults-btn" style="width: 100%; text-align: center; border-top: 1px solid #ccc; font-weight: bold;">Revert to Default Colors</button>
                    </div>
                </div>
                <select id="size-selector">
                    <option value="0.2">20%</option>
                    <option value="0.3">30%</option>
                    <option value="0.4">40%</option>
                    <option value="0.5">50%</option>
                    <option value="0.6">60%</option>
                    <option value="0.7">70%</option>
                    <option value="0.8">80%</option>
                    <option value="0.9">90%</option>
                    <option value="1" selected>100%</option>
                </select>
                <select id="sort-selector">
                    <option value="" disabled selected hidden>Sort</option>
                    <option value="name-asc">Name (A-Z)</option>
                    <option value="name-desc">Name (Z-A)</option>
                    <option value="date-new">Date (Newest)</option>
                    <option value="date-old">Date (Oldest)</option>
                </select>
                <button id="prev-canvas-btn" class="bar-button">&lt;</button>
                <select id="canvas-select"></select>
                <button id="next-canvas-btn" class="bar-button">&gt;</button>
                <select id="group-selector"></select>
                <div class="checkbox-container">
                    <input type="checkbox" id="show-dates-checkbox">
                    <label for="show-dates-checkbox">Show Dates</label>
                </div>
                <div class="checkbox-container">
                    <input type="checkbox" id="show-numbers-checkbox">
                    <label for="show-numbers-checkbox">Show Numbers</label>
                </div>
            </div>
            <div id="content-area" style="display: flex; flex-grow: 1; overflow: hidden;">
                <div id="thumbnail-container">
                    <div id="content-spacer" style="position: absolute; top: 0; left: 0; z-index: -1;"></div>
                </div>
            </div>
            <div class="bottom-bar">
                <div>
                    <button id="root-sc-btn" class="bar-button selection-type-button" style="display: none;"><span class="color-circle"></span>Root SC</button>
                    <button id="subfolder-sc-btn" class="bar-button selection-type-button" style="display: none;"><span class="color-circle"></span>Subfolder SC</button>
                    <button id="both-sc-btn" class="bar-button selection-type-button" style="display: none;"><span class="color-circle"></span>Both</button>
                    <button id="delete-sc-btn" class="bar-button selection-type-button" style="display: none;"><span class="color-circle"></span>Delete</button>
                </div>
                <div>
                    <button id="shortcut-script-btn" class="bar-button">Create Shortcut Script</button>
                    <button id="create-playlist-btn" class="bar-button" style="display: none;">Create Playlist</button>
                    <button id="delete-shortcuts-btn" class="bar-button" style="display: none;">Delete Selected Shortcuts</button>
                </div>
            </div>
        </div>
    </div>

    <div id="script-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Create Shortcut PowerShell Script</h2>
            <p>This script will create shortcuts for your selections. Right-click and "Run with PowerShell" in your main video directory.</p>
            <textarea id="batch-script" rows="10" cols="80" readonly></textarea>
            <button id="copy-script-btn">Copy to Clipboard</button>
            <a id="download-script-link" download="create_shortcuts.ps1">
                <button>Download .ps1 File</button>
            </a>
        </div>
    </div>

    <script>
        const thumbnailContainer = document.getElementById('thumbnail-container');
        const scriptModal = document.getElementById('script-modal');
        const batchScriptTextArea = document.getElementById('batch-script');
        const copyScriptBtn = document.getElementById('copy-script-btn');
        const downloadScriptLink = document.getElementById('download-script-link');
        const sizeSelector = document.getElementById('size-selector');
        const sortSelector = document.getElementById('sort-selector');
        const loadButton = document.getElementById('load-directory-btn');
        const loadScButton = document.getElementById('load-sc-btn');
        const loadLatestVideosButton = document.getElementById('load-latest-videos-btn');
        const loadRootScButton = document.getElementById('load-root-sc-btn');
        const createPlaylistLoadBtn = document.getElementById('create-playlist-load-btn');
        const shortcutScriptBtn = document.getElementById('shortcut-script-btn');
        const createPlaylistBtn = document.getElementById('create-playlist-btn');
        const deleteShortcutsBtn = document.getElementById('delete-shortcuts-btn');
        const xShortcutBtn = document.getElementById('x-shortcut-btn');
        const contentSpacer = document.getElementById('content-spacer');
        const canvasSelect = document.getElementById('canvas-select');
        const groupSelector = document.getElementById('group-selector');
        const rootScBtn = document.getElementById('root-sc-btn');
        const subfolderScBtn = document.getElementById('subfolder-sc-btn');
        const bothScBtn = document.getElementById('both-sc-btn');
        const deleteScBtn = document.getElementById('delete-sc-btn');
        const prevCanvasBtn = document.getElementById('prev-canvas-btn');
        const nextCanvasBtn = document.getElementById('next-canvas-btn');
        const loadMenuBtn = document.getElementById('load-menu-btn');
        const loadDropdown = document.getElementById('load-dropdown');
        const optionsMenuBtn = document.getElementById('options-menu-btn');
        const optionsDropdown = document.getElementById('options-dropdown');
        const revertDefaultsBtn = document.getElementById('revert-defaults-btn');

        let allVideoFiles = [];
        let allProjectFolders = [];
        let shortcutSelections = new Map(); // Key: projectPath + '|' + videoName, Value: { videoName, projectPath, subfolder, type }
        let initialShortcutSelections = new Map(); // Key: projectPath + '|' + videoName, Value: { type }
        let currentDirHandle;
        let g_rootHandle;
        let currentMode = '';
        let canvases = new Map();
        let activeCanvasId = 0;
        let createdObjectUrls = [];
        let dummyTimestampProjects = new Set();
        let currentSelectionType = 'root-sc';
        const mainContainer = document.querySelector('.main-container');
        const showDatesCheckbox = document.getElementById('show-dates-checkbox');
        const showNumbersCheckbox = document.getElementById('show-numbers-checkbox');

        function updateRowNumbers() {
            const showNumbers = showNumbersCheckbox.checked;
            mainContainer.classList.toggle('show-numbers', showNumbers);
            const containers = document.querySelectorAll('.thumbnails-container');
            
            // First, remove any existing numbers to avoid duplicates
            document.querySelectorAll('.row-number').forEach(num => num.remove());

            if (showNumbers) {
                containers.forEach((container, index) => {
                    const numberSpan = document.createElement('span');
                    numberSpan.className = 'row-number';
                    numberSpan.textContent = index + 1;
                    container.insertBefore(numberSpan, container.firstChild);
                });
            }
        }

        function init() {
            loadMenuBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                optionsDropdown.style.display = 'none';
                loadDropdown.style.display = loadDropdown.style.display === 'block' ? 'none' : 'block';
            });

            optionsMenuBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                loadDropdown.style.display = 'none';
                optionsDropdown.style.display = optionsDropdown.style.display === 'block' ? 'none' : 'block';
            });

            window.addEventListener('click', () => {
                loadDropdown.style.display = 'none';
                optionsDropdown.style.display = 'none';
            });

            optionsDropdown.addEventListener('click', (e) => {
                e.stopPropagation();
            });

            const colorPickers = {
                'bg-color': document.getElementById('bg-color-picker'),
                'toolbar-color': document.getElementById('toolbar-color-picker'),
                'root-sc-color': document.getElementById('root-sc-color-picker'),
                'subfolder-sc-color': document.getElementById('subfolder-sc-color-picker'),
                'both-sc-color': document.getElementById('both-sc-color-picker'),
                'delete-sc-color': document.getElementById('delete-sc-color-picker'),
                'header-text-color': document.getElementById('header-text-color-picker'),
                'row-number-color': document.getElementById('row-number-color-picker'),
                'date-text-color': document.getElementById('date-text-color-picker')
            };

            // Load saved colors
            Object.keys(colorPickers).forEach(id => {
                const picker = colorPickers[id];
                if (!picker) return;
                const saved = localStorage.getItem(`sc-color-${id}`);
                if (saved) {
                    document.documentElement.style.setProperty(`--${id}`, saved);
                    picker.value = saved;
                }
            });

            // Handle color changes
            Object.keys(colorPickers).forEach(id => {
                const picker = colorPickers[id];
                if (!picker) return;
                picker.addEventListener('input', (e) => {
                    const color = e.target.value;
                    document.documentElement.style.setProperty(`--${id}`, color);
                    localStorage.setItem(`sc-color-${id}`, color);
                    if (id.includes('sc-color')) {
                        updateCircleColors();
                    }
                });
            });

            if (revertDefaultsBtn) {
                revertDefaultsBtn.addEventListener('click', () => {
                    const defaults = {
                        'bg-color': '#3d0021',
                        'toolbar-color': '#1c1c1c',
                        'root-sc-color': '#ffe11f',
                        'subfolder-sc-color': '#00ff1e',
                        'both-sc-color': '#009dff',
                        'delete-sc-color': '#ff0101',
                        'header-text-color': '#01ff01',
                        'row-number-color': '#fcfc01',
                        'date-text-color': '#01ffff'
                    };
                    Object.keys(defaults).forEach(id => {
                        const color = defaults[id];
                        document.documentElement.style.setProperty(`--${id}`, color);
                        if (colorPickers[id]) {
                            colorPickers[id].value = color;
                        }
                        localStorage.removeItem(`sc-color-${id}`);
                    });
                    updateCircleColors();
                });
            }

            updateCircleColors();

            loadButton.addEventListener('click', async () => {
                try {
                    const dirHandle = await window.showDirectoryPicker();
                    currentDirHandle = dirHandle;
                    g_rootHandle = null;
                    currentMode = 'directory';
                    setVisibilityForMode(currentMode);
                    await renderDirectoryMode();
                } catch (err) {
                    if (err.name !== 'AbortError') console.error('Failed to open directory:', err);
                }
            });

            loadScButton.addEventListener('click', async () => {
                try {
                    const dirHandle = await window.showDirectoryPicker();
                    currentDirHandle = dirHandle;
                    g_rootHandle = null;
                    currentMode = 'sc';
                    setVisibilityForMode(currentMode);
                    await renderVideosInternal(false, sortSelector.value, true);
                } catch (err) {
                    if (err.name !== 'AbortError') {
                        console.error('Failed to open directory or render SC mode:', err);
                    }
                }
            });


            loadLatestVideosButton.addEventListener('click', async () => {
                try {
                    const dirHandle = await window.showDirectoryPicker();
                    currentDirHandle = dirHandle;
                    g_rootHandle = null;
                    currentMode = 'latest-videos';
                    setVisibilityForMode(currentMode);
                    await renderLatestVideosMode();
                } catch (err) {
                    if (err.name !== 'AbortError') {
                        console.error('Failed to open directory or render latest videos mode:', err);
                    }
                }
            });

            scriptModal.querySelector('.close').addEventListener('click', () => scriptModal.style.display = 'none');
            
            copyScriptBtn.addEventListener('click', () => {
                 batchScriptTextArea.select();
                 navigator.clipboard.writeText(batchScriptTextArea.value).then(() => {
                    alert('Script copied to clipboard!');
                });
            });

            shortcutScriptBtn.addEventListener('click', () => {
                const hasSelections = shortcutSelections.size > 0;
                const hasDeletions = Array.from(initialShortcutSelections.keys()).some(key => !shortcutSelections.has(key));
                const hasModifiedType = Array.from(shortcutSelections.entries()).some(([key, sel]) => {
                    const initial = initialShortcutSelections.get(key);
                    return initial && initial.type !== sel.type;
                });
                const hasDummyTimestamp = dummyTimestampProjects.size > 0;

                if (!hasSelections && !hasDeletions && !hasModifiedType && !hasDummyTimestamp) {
                    alert('No changes to save.');
                    return;
                }
                generateShortcutScript();
                scriptModal.style.display = 'block';
            });

            sizeSelector.addEventListener('change', () => layoutLandscapeThumbnails());
            
            sortSelector.addEventListener('change', (e) => {
                if(currentDirHandle) {
                    if (currentMode === 'directory') {
                        renderDirectoryMode(e.target.value);
                    } else if (currentMode === 'latest-videos') {
                        renderLatestVideosMode(e.target.value);
                    } else if (currentMode === 'sc' || currentMode === 'root-sc') {
                        renderVideosInternal(false, e.target.value, true);
                    }
                }
            });

            loadRootScButton.addEventListener('click', async () => {
                try {
                    const dirHandle = await window.showDirectoryPicker();
                    currentDirHandle = dirHandle;
                    g_rootHandle = null;
                    currentMode = 'root-sc';
                    setVisibilityForMode(currentMode);
                    await renderVideosInternal(false, sortSelector.value, true);
                } catch (err) {
                    if (err.name !== 'AbortError') {
                        console.error('Failed to open directory or render Root SC mode:', err);
                    }
                }
            });

            createPlaylistLoadBtn.addEventListener('click', async () => {
                try {
                    const dirHandle = await window.showDirectoryPicker();
                    currentDirHandle = dirHandle;
                    currentMode = 'playlist';
                    setSelectionType('both-sc');
                    setVisibilityForMode(currentMode);
                    await renderPlaylistMode();
                } catch (err) {
                    if (err.name !== 'AbortError') {
                        console.error('Failed to open directory or render playlist mode:', err);
                    }
                }
            });

            createPlaylistBtn.addEventListener('click', () => {
                if (shortcutSelections.size === 0) {
                    alert('Please select one or more directories to include in the playlist.');
                    return;
                }
                generatePlaylistScript();
                scriptModal.style.display = 'block';
            });

            deleteScBtn.addEventListener('click', () => setSelectionType('delete-sc'));

            deleteShortcutsBtn.addEventListener('click', () => {
                if (shortcutSelections.size === 0) {
                    alert('Please select one or more shortcuts to delete.');
                    return;
                }
                generateDeleteScript();
                scriptModal.style.display = 'block';
            });

            rootScBtn.addEventListener('click', () => setSelectionType('root-sc'));
            subfolderScBtn.addEventListener('click', () => setSelectionType('subfolder-sc'));
            bothScBtn.addEventListener('click', () => setSelectionType('both-sc'));

            prevCanvasBtn.addEventListener('click', () => navigateCanvas(-1));
            nextCanvasBtn.addEventListener('click', () => navigateCanvas(1));
        }

        function navigateCanvas(direction) {
            const canvasIds = Array.from(canvases.keys());
            if (canvasIds.length <= 1) return;

            const currentIndex = canvasIds.indexOf(activeCanvasId);
            let nextIndex = currentIndex + direction;

            if (nextIndex < 0) {
                nextIndex = canvasIds.length - 1;
            } else if (nextIndex >= canvasIds.length) {
                nextIndex = 0;
            }

            const nextCanvasId = canvasIds[nextIndex];
            renderCanvas(nextCanvasId);
        }

        function setSelectionType(type) {
            currentSelectionType = type;
            updateSelectionTypeButtons();
        }

        function updateCircleColors() {
            const getCircle = (btn) => btn ? btn.querySelector('.color-circle') : null;
            
            const rootCircle = getCircle(rootScBtn);
            const subfolderCircle = getCircle(subfolderScBtn);
            const bothCircle = getCircle(bothScBtn);
            const deleteCircle = getCircle(deleteScBtn);
            
            if (rootCircle) rootCircle.style.backgroundColor = getComputedStyle(document.documentElement).getPropertyValue('--root-sc-color');
            if (subfolderCircle) subfolderCircle.style.backgroundColor = getComputedStyle(document.documentElement).getPropertyValue('--subfolder-sc-color');
            if (bothCircle) bothCircle.style.backgroundColor = getComputedStyle(document.documentElement).getPropertyValue('--both-sc-color');
            if (deleteCircle) deleteCircle.style.backgroundColor = getComputedStyle(document.documentElement).getPropertyValue('--delete-sc-color');
        }

        function updateSelectionTypeButtons() {
            if (rootScBtn) rootScBtn.classList.toggle('active', currentSelectionType === 'root-sc');
            if (subfolderScBtn) subfolderScBtn.classList.toggle('active', currentSelectionType === 'subfolder-sc');
            if (bothScBtn) bothScBtn.classList.toggle('active', currentSelectionType === 'both-sc');
            if (deleteScBtn) deleteScBtn.classList.toggle('active', currentSelectionType === 'delete-sc');
        }

        function renderCanvas(canvasId) {
            if (!canvases.has(canvasId)) return;

            activeCanvasId = canvasId;
            thumbnailContainer.innerHTML = ''; // Clear container

            const canvas = canvases.get(canvasId);
            if (canvas && canvas.elements) {
                canvas.elements.forEach(el => {
                    thumbnailContainer.appendChild(el);
                });
            }

            populateCanvasDropdown();
            layoutLandscapeThumbnails(); // Re-layout after switching canvas
            updateRowNumbers(); // Ensure numbers are shown if enabled
        }

        function populateCanvasDropdown() {
            canvasSelect.innerHTML = '';
            for (const canvas of canvases.values()) {
                const option = document.createElement('option');
                option.value = canvas.id;
                option.textContent = canvas.name;
                canvasSelect.appendChild(option);
            }
            if (canvases.has(activeCanvasId)) {
                canvasSelect.value = activeCanvasId;
            }
        }

        canvasSelect.addEventListener('change', (e) => {
            const newCanvasId = parseInt(e.target.value, 10);
            if (newCanvasId !== activeCanvasId) {
                renderCanvas(newCanvasId);
            }
        });

        async function findDirectoryHandleByName(dirHandle, name) {
            const lowerCaseName = name.toLowerCase();
            for await (const entry of dirHandle.values()) {
                if (entry.kind === 'directory' && entry.name.toLowerCase() === lowerCaseName) {
                    return entry;
                }
            }
            throw new Error(`Directory '${name}' not found.`);
        }

        function setVisibilityForMode(mode) {
            const checkboxContainers = document.querySelectorAll('.checkbox-container');

            const isDirectory = mode === 'directory';
            const isSc = mode === 'sc';
            const isRootSc = mode === 'root-sc';
            const isScNew = mode === 'sc-new';
            const isLatestVideos = mode === 'latest-videos';
            const isPlaylist = mode === 'playlist';

            deleteShortcutsBtn.style.display = 'none'; // Script handles deletions now
            shortcutScriptBtn.style.display = isPlaylist ? 'none' : 'inline-block';
            createPlaylistBtn.style.display = isPlaylist ? 'inline-block' : 'none';

            checkboxContainers.forEach(el => el.style.display = 'flex');
            canvasSelect.style.display = (isDirectory || isSc || isRootSc || isScNew || isLatestVideos || isPlaylist) ? 'inline-block' : 'none';
            groupSelector.style.display = 'none';

            const showSelectionButtons = isLatestVideos || isDirectory || isSc || isRootSc || isScNew || isPlaylist;
            if (rootScBtn) rootScBtn.style.display = showSelectionButtons ? 'inline-block' : 'none';
            if (subfolderScBtn) subfolderScBtn.style.display = showSelectionButtons ? 'inline-block' : 'none';
            if (bothScBtn) bothScBtn.style.display = showSelectionButtons ? 'inline-block' : 'none';
            if (deleteScBtn) deleteScBtn.style.display = (showSelectionButtons && !isPlaylist) ? 'inline-block' : 'none';
            if (showSelectionButtons) {
                updateSelectionTypeButtons();
            }
        }

        showDatesCheckbox.addEventListener('change', () => {
            mainContainer.classList.toggle('show-dates', showDatesCheckbox.checked);
        });


        showNumbersCheckbox.addEventListener('change', updateRowNumbers);

        function updateContentSpacer() {
            const elements = document.querySelectorAll('.landscape-row, .project-header, hr');
            if (elements.length === 0) {
                contentSpacer.style.height = '0px';
                return;
            }
            let maxBottom = 0;
            elements.forEach(el => {
                const bottom = el.offsetTop + el.offsetHeight;
                if (bottom > maxBottom) maxBottom = bottom;
            });
            contentSpacer.style.height = (maxBottom + 20) + 'px';
        }

        function layoutLandscapeThumbnails() {
            const scale = parseFloat(sizeSelector.value);
            const elements = document.querySelectorAll('.landscape-row, .project-header, hr');

            elements.forEach(element => {
                if (element.classList.contains('landscape-row')) {
                    const thumbnails = element.querySelectorAll('.thumbnail');
                    thumbnails.forEach(thumb => {
                        const originalWidth = parseFloat(thumb.dataset.originalWidth);
                        const originalHeight = parseFloat(thumb.dataset.originalHeight);
                        const scaledWidth = originalWidth * scale;
                        const scaledHeight = originalHeight * scale;
                        thumb.style.width = scaledWidth + 'px';
                        thumb.style.height = scaledHeight + 'px';
                        thumb.style.marginRight = '10px';
                        thumb.style.marginBottom = '10px';
                    });
                }
            });
            updateRowNumbers();
            requestAnimationFrame(updateContentSpacer);
        }

        function escapePSString(str) {
            if (typeof str !== 'string') return '';
            return str.replace(/'/g, "''");
        }

        function generateShortcutScript() {
            const selectionsToProcess = Array.from(shortcutSelections.values());
            const displayedProjectPaths = new Set(Array.from(canvases.values()).map(c => c.path));
            const selectedProjectPaths = new Set(selectionsToProcess.map(s => s.projectPath));
            const dummyTimestampProjects = new Set([...displayedProjectPaths].filter(p => !selectedProjectPaths.has(p)));

            let scriptLines = [
                '$PSScriptRoot = Split-Path -Parent -Path $MyInvocation.MyCommand.Definition',
                '$wshell = New-Object -ComObject WScript.Shell',
                ''
            ];

            const hasCreations = selectionsToProcess.some(sel => {
                if (sel.type === 'delete-sc') return false;
                const key = sel.projectPath + '|' + sel.videoName;
                const initial = initialShortcutSelections.get(key);
                return !initial || initial.type !== sel.type;
            });

            if (hasCreations) {
                 scriptLines.push('# --- Creating Shortcuts ---');
            }

            let needsRootSc = false;
            const subfolderProjects = new Set();
            selectionsToProcess.forEach(sel => {
                const selectionType = sel.type || 'root-sc';
                if (selectionType === 'root-sc' || selectionType === 'both-sc') {
                    needsRootSc = true;
                }
                if ((selectionType === 'subfolder-sc' || selectionType === 'both-sc') && sel.projectPath) {
                    subfolderProjects.add(sel.projectPath);
                }
            });

            if (needsRootSc) {
                scriptLines.push(`$rootScFolder = Join-Path -Path $PSScriptRoot -ChildPath 'sc'`);
                scriptLines.push('if (-not (Test-Path -Path $rootScFolder)) { New-Item -ItemType Directory -Path $rootScFolder -Force | Out-Null }');
                scriptLines.push('');
            }
            
            subfolderProjects.forEach(projectPath => {
                const escapedProjectPath = escapePSString(projectPath);
                scriptLines.push(`$subfolderScPath = Join-Path -Path (Join-Path -Path $PSScriptRoot -ChildPath '${escapedProjectPath}') -ChildPath 'sc'`);
                scriptLines.push(`if (-not (Test-Path -Path $subfolderScPath)) { New-Item -ItemType Directory -Path $subfolderScPath -Force | Out-Null }`);
            });
            if (subfolderProjects.size > 0) {
                scriptLines.push('');
            }

            selectionsToProcess.forEach(sel => {
                const key = sel.projectPath + '|' + sel.videoName;
                const initial = initialShortcutSelections.get(key);
                if (initial && initial.type === sel.type) {
                    return; // Skip if unchanged
                }
                
                const selectionType = sel.type || 'root-sc';
                if (selectionType === 'delete-sc') return;

                const escapedVideoName = escapePSString(sel.videoName);
                const escapedProjectPath = escapePSString(sel.projectPath);
                const escapedSubfolder = escapePSString(sel.subfolder);

                let targetPathConstruction = `$PSScriptRoot`;
                if (sel.projectPath) {
                    targetPathConstruction = `(Join-Path -Path ${targetPathConstruction} -ChildPath '${escapedProjectPath}')`;
                }
                if (sel.subfolder) {
                    targetPathConstruction = `(Join-Path -Path ${targetPathConstruction} -ChildPath '${escapedSubfolder}')`;
                }
                targetPathConstruction = `Join-Path -Path ${targetPathConstruction} -ChildPath '${escapedVideoName}'`;

                scriptLines.push(`    # Shortcut for: ${sel.projectPath}\\${sel.videoName} (Type: ${selectionType})`);
                scriptLines.push(`    $targetPath = ${targetPathConstruction}`);

                const createShortcut = (scPath, logMsg) => {
                    scriptLines.push(`    $shortcutPath = ${scPath}`);
                    scriptLines.push('    try {');
                    scriptLines.push('        $shortcut = $wshell.CreateShortcut($shortcutPath)');
                    scriptLines.push('        $shortcut.TargetPath = $targetPath');
                    scriptLines.push('        $shortcut.Save()');
                    scriptLines.push(`        Write-Host "${logMsg}"`);
                    scriptLines.push('    } catch {');
                    scriptLines.push('        Write-Host "FAILED to create shortcut: $shortcutPath" -ForegroundColor Red');
                    scriptLines.push('        Write-Host $_.Exception.Message -ForegroundColor Red');
                    scriptLines.push('    }');
                };

                if (selectionType === 'root-sc' || selectionType === 'both-sc') {
                    createShortcut(`Join-Path -Path $rootScFolder -ChildPath ('${escapedVideoName}' + '.lnk')`, `Created root shortcut: ${escapedVideoName}`);
                }

                if (selectionType === 'subfolder-sc' || selectionType === 'both-sc') {
                    const scDirPath = `Join-Path -Path (Join-Path -Path $PSScriptRoot -ChildPath '${escapedProjectPath}') -ChildPath 'sc'`;
                    const logPath = (escapedProjectPath ? escapedProjectPath + '\\' : '') + escapedVideoName;
                    createShortcut(`Join-Path -Path (${scDirPath}) -ChildPath ('${escapedVideoName}' + '.lnk')`, `Created subfolder shortcut: ${logPath}`);
                }
                scriptLines.push('');
            });

            // --- File Deletions (Videos and Thumbnails) ---
            const fileDeletions = selectionsToProcess.filter(sel => sel.type === 'delete-sc');
            if (fileDeletions.length > 0) {
                scriptLines.push('# --- Deleting Videos and Thumbnails ---');
                fileDeletions.forEach(sel => {
                    const escapedVideoName = escapePSString(sel.videoName);
                    const escapedProjectPath = escapePSString(sel.projectPath);
                    const escapedSubfolder = escapePSString(sel.subfolder);
                    
                    let videoPathVar = `$PSScriptRoot`;
                    if (sel.projectPath) videoPathVar = `(Join-Path -Path ${videoPathVar} -ChildPath '${escapedProjectPath}')`;
                    if (sel.subfolder) videoPathVar = `(Join-Path -Path ${videoPathVar} -ChildPath '${escapedSubfolder}')`;
                    scriptLines.push(`$videoPath = Join-Path -Path ${videoPathVar} -ChildPath '${escapedVideoName}'`);
                    
                    scriptLines.push(`if (Test-Path -LiteralPath $videoPath) {`);
                    scriptLines.push(`    Remove-Item -LiteralPath $videoPath -Force`);
                    scriptLines.push(`    Write-Host "Deleted video: ${escapedVideoName}"`);
                    scriptLines.push(`}`);
                    
                    const thumbBase = sel.videoName.substring(0, sel.videoName.lastIndexOf('.'));
                    const escapedThumbBase = escapePSString(thumbBase);
                    
                    scriptLines.push(`$projectPath = Join-Path -Path $PSScriptRoot -ChildPath '${escapedProjectPath}'`);
                    scriptLines.push(`$thumbDirs = @('Thumbnails', 'Edit Thumbnails')`);
                    scriptLines.push(`foreach ($dirName in $thumbDirs) {`);
                    scriptLines.push(`    $dirPath = Join-Path -Path $projectPath -ChildPath $dirName`);
                    scriptLines.push(`    if (Test-Path -LiteralPath $dirPath) {`);
                    scriptLines.push(`        Get-ChildItem -Path $dirPath -Filter '${escapedThumbBase}_*' | Remove-Item -Force`);
                    scriptLines.push(`        Write-Host "Deleted thumbnails for ${escapedVideoName} in $dirName"`);
                    scriptLines.push(`    }`);
                    scriptLines.push(`}`);
                    scriptLines.push('');
                });
            }

            // --- Deletions ---
            const deletions = [];
            initialShortcutSelections.forEach((initial, key) => {
                const current = shortcutSelections.get(key);
                const parts = key.split('|');
                const projectPath = parts[0];
                const videoName = parts[1];
                const escapedVideoName = escapePSString(videoName);
                const escapedProjectPath = escapePSString(projectPath);

                const initiallyInSubfolder = initial.type === 'subfolder-sc' || initial.type === 'both-sc';
                const currentlyInSubfolder = current && (current.type === 'subfolder-sc' || current.type === 'both-sc');
                if (initiallyInSubfolder && !currentlyInSubfolder) {
                    const subfolderScPath = `(Join-Path -Path (Join-Path -Path $PSScriptRoot -ChildPath '${escapedProjectPath}') -ChildPath 'sc')`;
                    const fullScPath = `(Join-Path -Path ${subfolderScPath} -ChildPath ('${escapedVideoName}' + '.lnk'))`;
                    const logPath = (escapedProjectPath ? escapedProjectPath + '\\' : '') + escapedVideoName;
                    deletions.push(`if (Test-Path -LiteralPath ${fullScPath}) { Remove-Item -LiteralPath ${fullScPath}; Write-Host "Deleted subfolder shortcut: ${logPath}" }`);
                }

                const initiallyInRoot = initial.type === 'root-sc' || initial.type === 'both-sc';
                const currentlyInRoot = current && (current.type === 'root-sc' || current.type === 'both-sc');
                if (initiallyInRoot && !currentlyInRoot) {
                    const rootScFolder = `(Join-Path -Path $PSScriptRoot -ChildPath 'sc')`;
                    const fullScPath = `(Join-Path -Path ${rootScFolder} -ChildPath ('${escapedVideoName}' + '.lnk'))`;
                    deletions.push(`if (Test-Path -LiteralPath ${fullScPath}) { Remove-Item -LiteralPath ${fullScPath}; Write-Host "Deleted root shortcut: ${escapedVideoName}" }`);
                }
            });

            if (deletions.length > 0) {
                scriptLines.push('# --- Deleting Shortcuts ---');
                scriptLines.push(...deletions);
                scriptLines.push('');
            }

            const timestamp = new Date().toISOString();

            if (selectedProjectPaths.size > 0) {
                scriptLines.push('# --- Placing Genuine Timestamps ---');
                
                selectedProjectPaths.forEach(projectPath => {
                    const escapedProjectPath = escapePSString(projectPath);
                    const projectPathVar = projectPath ? `Join-Path -Path $PSScriptRoot -ChildPath '${escapedProjectPath}'` : '$PSScriptRoot';

                    scriptLines.push(`Write-Host "Placing genuine timestamp for project: ${projectPath || '(Root)'}"`);
                    scriptLines.push(`$projectFolder = ${projectPathVar}`);
                    scriptLines.push(`$scDateFile = Join-Path -Path $projectFolder -ChildPath 'scdate.txt'`);
                    scriptLines.push(`Set-Content -Path $scDateFile -Value "${timestamp}"`);
                    scriptLines.push('');
                });
            }

            if (dummyTimestampProjects.size > 0) {
                scriptLines.push('# --- Placing Dummy Timestamps ---');
                
                dummyTimestampProjects.forEach(projectPath => {
                    const escapedProjectPath = escapePSString(projectPath);
                    const projectPathVar = projectPath ? `Join-Path -Path $PSScriptRoot -ChildPath '${escapedProjectPath}'` : '$PSScriptRoot';

                    scriptLines.push(`Write-Host "Placing dummy timestamp for project: ${projectPath || '(Root)'}"`);
                    scriptLines.push(`$projectFolder = ${projectPathVar}`);
                    scriptLines.push(`$scDateFile = Join-Path -Path $projectFolder -ChildPath 'scdate.txt'`);
                    scriptLines.push(`Set-Content -Path $scDateFile -Value "dummy:${timestamp}"`);
                    scriptLines.push('');
                });
            }

            scriptLines.push('Write-Host "Script execution complete."');
            scriptLines.push('Read-Host -Prompt "Press Enter to exit"');

            const script = scriptLines.join('\r\n');
            batchScriptTextArea.value = script;
            const blob = new Blob([script], { type: 'text/plain;charset=utf-8' });
            downloadScriptLink.href = URL.createObjectURL(blob);
        }


        function getNextCanvasId() {
            let i = 1;
            while (canvases.has(i)) {
                i++;
            }
            return i;
        }

        function normalizeLine(line) {
            return line.trim().replace(/^["']|["']$/g, '').toLowerCase();
        }

        function normalizeProjectKey(key) {
            return key.trim().replace(/^[\\/"'\[\]]+|[\\/"'\[\]]+$/g, '').replace(/\\/g, '/').toLowerCase();
        }

        async function getScDataForProject(projectHandle) {
            const allShortcuts = new Set();
            
            async function scanDir(dirHandle) {
                try {
                    const handle = await dirHandle.getFileHandle('scdata.txt');
                    const file = await handle.getFile();
                    const text = await file.text();
                    text.split('\n').map(normalizeLine).filter(l => l).forEach(s => allShortcuts.add(s));
                } catch (e) {}

                for await (const entry of dirHandle.values()) {
                    if (entry.kind === 'directory' && entry.name.toLowerCase() !== 'sc' && entry.name.toLowerCase() !== 'edit thumbnails' && entry.name.toLowerCase() !== 'thumbnails') {
                        await scanDir(entry);
                    }
                }
            }
            
            await scanDir(projectHandle);
            console.log(`Loaded ${allShortcuts.size} shortcuts from project (recursive): ${projectHandle.name}`);
            return allShortcuts;
        }

        async function getRootScData(rootHandle) {
            try {
                let handle;
                try {
                    handle = await rootHandle.getFileHandle('rootdata.txt');
                } catch (e) {
                    handle = await rootHandle.getFileHandle('scdata.txt');
                }
                const file = await handle.getFile();
                const text = await file.text();
                const data = parseRootScData(text);
                console.log(`Loaded root data from ${rootHandle.name}. Projects found: ${data.size}`);
                return data;
            } catch (e) {
                return new Map();
            }
        }

        function checkShortcut(videoName, scDataSet) {
            const baseName = videoName.substring(0, videoName.lastIndexOf('.'));
            const namesToCheck = [
                videoName.toLowerCase() + ".lnk",
                videoName.toLowerCase() + ".ink",
                videoName.toLowerCase() + " - shortcut.lnk",
                videoName.toLowerCase()
            ];
            if (baseName) {
                namesToCheck.push(baseName.toLowerCase() + ".lnk");
                namesToCheck.push(baseName.toLowerCase() + ".ink");
                namesToCheck.push(baseName.toLowerCase() + " - shortcut.lnk");
                namesToCheck.push(baseName.toLowerCase());
            }
            if (scDataSet instanceof Set) {
                return namesToCheck.some(n => scDataSet.has(n));
            } else if (scDataSet instanceof Map) {
                for (const n of namesToCheck) {
                    if (scDataSet.has(n)) return scDataSet.get(n);
                }
            }
            return false;
        }

        // Function to safely read and parse scdate.txt
        // Returns null if the file is missing or invalid
        async function getTimestamp(dirHandle) {
            try {
                const scDateHandle = await dirHandle.getFileHandle('scdate.txt');
                const file = await scDateHandle.getFile();
                let text = await file.text();
                if (text.startsWith('dummy:')) {
                    text = text.substring(6);
                }
                const raw = text.trim();
                if (!raw) return null;
                const date = raw.endsWith('Z') ? new Date(raw) : new Date(raw + 'Z');
                if (!isNaN(date)) {
                    return date.getTime();
                }
            } catch (e) {
                // scdate.txt doesn't exist or is invalid
            }
            return null;
        }

        async function renderDirectoryMode(sortBy = 'name-asc') {
            await renderVideosInternal(false, sortBy, false);
        }

        async function renderLatestVideosMode(sortBy = 'name-asc') {
            await renderVideosInternal(true, sortBy, false);
        }

        async function renderVideosInternal(isNewOnly = false, sortBy = 'name-asc', isShortcutsOnly = false) {
            console.log(`Starting renderVideosInternal (isNewOnly=${isNewOnly}, isShortcutsOnly=${isShortcutsOnly}, currentMode=${currentMode})`);
            if (currentMode === 'root-sc') {
                g_rootHandle = currentDirHandle;
            }
            createdObjectUrls.forEach(URL.revokeObjectURL);
            createdObjectUrls = [];
            canvases.clear();
            shortcutSelections.clear();
            initialShortcutSelections.clear();
            thumbnailContainer.innerHTML = '';
            allVideoFiles = [];

            const projectFolders = [];

            async function findProjectFolders(dirHandle, currentPath = '') {
                 for await (const entry of dirHandle.values()) {
                    if (entry.kind === 'directory') {
                        const newPath = currentPath ? `${currentPath}\\${entry.name}` : entry.name;
                        try {
                            await findDirectoryHandleByName(entry, 'Edit Thumbnails');
                            
                            let timestamp = 0;
                            if (isNewOnly) {
                                timestamp = (await getTimestamp(entry)) || 0;
                            }

                            projectFolders.push({ 
                                handle: entry, 
                                path: newPath, 
                                name: entry.name,
                                timestamp: timestamp 
                            });
                        } catch (e) {
                           await findProjectFolders(entry, newPath);
                        }
                    }
                }
            }
            
            try {
                await findDirectoryHandleByName(currentDirHandle, 'Edit Thumbnails');
                let timestamp = 0;
                if (isNewOnly) {
                    timestamp = (await getTimestamp(currentDirHandle)) || 0;
                }
                projectFolders.push({ 
                    handle: currentDirHandle, 
                    path: '', 
                    name: currentDirHandle.name,
                    timestamp: timestamp
                });
            } catch (e) {
                await findProjectFolders(currentDirHandle);
            }

            projectFolders.sort((a, b) => a.name.localeCompare(b.name));

            let isProject = false;
            try {
                await findDirectoryHandleByName(currentDirHandle, 'Edit Thumbnails');
                isProject = true;
            } catch (e) {}

            let rootScData = new Map();
            let currentDirScData = new Map();
            if (!isProject) {
                currentDirScData = await getRootScData(currentDirHandle);
            }
            
            const hasProjectHeaders = Array.from(currentDirScData.keys()).some(k => k !== "");
            if (hasProjectHeaders || (currentDirScData.size > 0 && !isProject)) {
                // currentDirHandle looks like a root directory
                g_rootHandle = currentDirHandle;
                rootScData = currentDirScData;
            } else if (g_rootHandle) {
                // already have root handle
                rootScData = await getRootScData(g_rootHandle);
            } else if (!isNewOnly && (isProject || projectFolders.length > 0)) {
                if (confirm("Would you like to select the root folder to enable root shortcut detection?")) {
                    try {
                        const rootHandle = await window.showDirectoryPicker();
                        g_rootHandle = rootHandle;
                        rootScData = await getRootScData(g_rootHandle);
                    } catch (e) {}
                }
            }

            if (projectFolders.length === 0) {
                alert('No "Edit Thumbnails" folders found in the selected directory or its subdirectories.');
                return;
            }

            // Pre-calculate sets/maps for root shortcuts for performance
            const rootScDataSets = new Map();
            for (const [key, val] of rootScData.entries()) {
                rootScDataSets.set(key, val);
            }

            if (g_rootHandle) {
                for (const project of projectFolders) {
                    try {
                        const relativePathParts = await g_rootHandle.resolve(project.handle);
                        if (relativePathParts) {
                            project.path = relativePathParts.join('\\');
                        }
                    } catch (e) {
                        console.warn(`Could not resolve path for ${project.name} relative to root.`);
                    }
                }
            }

            const allImageLoadPromises = [];
            for (const project of projectFolders) {
                console.log(`Processing project: ${project.name} (Path: ${project.path})`);
                const projectScData = await getScDataForProject(project.handle);
                
                const normalizedProjectName = normalizeProjectKey(project.name);
                const normalizedProjectPath = normalizeProjectKey(project.path);
                console.log(`Matching project: Name="${normalizedProjectName}", Path="${normalizedProjectPath}"`);
                
                let rootProjectShortcutsSet = rootScDataSets.get(normalizedProjectName) || new Set();
                if (rootProjectShortcutsSet.size === 0 && normalizedProjectPath && normalizedProjectPath !== normalizedProjectName) {
                    rootProjectShortcutsSet = rootScDataSets.get(normalizedProjectPath) || new Set();
                }
                console.log(`Project: ${project.name}, rootProjectShortcutsSet size: ${rootProjectShortcutsSet.size}`);

                const canvasId = getNextCanvasId();
                const canvasElements = [];
                let mostRecentShortcutTime = project.timestamp || 0;

                const projectVideoFiles = [];
                // Recursively find videos in subfolders
                async function findVideos(dirHandle, subfolder = '') {
                    for await (const entry of dirHandle.values()) {
                        if (entry.kind === 'file' && entry.name.match(/\.(mp4|avi|mov|mkv)$/i)) {
                            const file = await entry.getFile();
                            if (!isNewOnly || file.lastModified > mostRecentShortcutTime) {
                                // Store additional path info on the file object
                                file.subfolder = subfolder;
                                file.projectPath = project.path;
                                projectVideoFiles.push(file);
                            } else if (isNewOnly) {
                                console.log(`Filtering out old video: ${entry.name} (Modified: ${new Date(file.lastModified).toLocaleString()}, Cutoff: ${new Date(mostRecentShortcutTime).toLocaleString()})`);
                            }
                        } else if (entry.kind === 'directory' && entry.name.toLowerCase() !== 'edit thumbnails' && entry.name.toLowerCase() !== 'thumbnails' && entry.name.toLowerCase() !== 'sc') {
                            await findVideos(entry, subfolder ? `${subfolder}\\${entry.name}` : entry.name);
                        }
                    }
                }
                await findVideos(project.handle);
                allVideoFiles.push(...projectVideoFiles);

                const editDirHandle = await findDirectoryHandleByName(project.handle, 'Edit Thumbnails');
                const landscapeFiles = [];
                 for await (const entry of editDirHandle.values()) {
                    if (entry.kind === 'file' && entry.name.match(/\.(jpe?g|png|gif|webp)$/i)) {
                        landscapeFiles.push(await entry.getFile());
                    }
                }

                const groupedFiles = landscapeFiles.reduce((acc, file) => {
                    const match = file.name.match(/^(.*?)_(\d+)\.[^.]+$/);
                    if (match) {
                        const videoName = match[1];
                        if (!acc[videoName]) acc[videoName] = [];
                        acc[videoName].push(file);
                    }
                    return acc;
                }, {});

                const videoFileMap = new Map(projectVideoFiles.map(f => [f.name.substring(0, f.name.lastIndexOf('.')), f]));
                
                let videoNames = Object.keys(groupedFiles);
                videoNames.sort((a, b) => {
                    if (sortBy === 'name-asc') return a.localeCompare(b);
                    if (sortBy === 'name-desc') return b.localeCompare(a);
                    const fileA = videoFileMap.get(a);
                    const fileB = videoFileMap.get(b);
                    const dateA = fileA ? fileA.lastModified : 0;
                    const dateB = fileB ? fileB.lastModified : 0;
                    if (sortBy === 'date-new') return dateB - dateA;
                    if (sortBy === 'date-old') return dateA - dateB;
                    return 0;
                });

                const projectRows = [];
                const hasAnyShortcuts = projectScData.size > 0 || rootProjectShortcutsSet.size > 0;

                for (const videoName of videoNames) {
                    const videoFile = videoFileMap.get(videoName);
                    if (!videoFile) continue;

                    const hasProjectSc = checkShortcut(videoFile.name, projectScData);
                    let rootScEntry = checkShortcut(videoFile.name, rootProjectShortcutsSet);

                    // If not found in project-specific group, check if it's in a group named after the subfolder (for nested videos)
                    if (!rootScEntry && videoFile.subfolder) {
                        const subfolderLeaf = videoFile.subfolder.split(/[\\/]/).pop();
                        if (subfolderLeaf) {
                            const normalizedSubfolderLeaf = normalizeProjectKey(subfolderLeaf);
                            const subfolderRootScSet = rootScDataSets.get(normalizedSubfolderLeaf);
                            if (subfolderRootScSet) {
                                rootScEntry = checkShortcut(videoFile.name, subfolderRootScSet);
                            }
                        }
                    }
                    
                    // Also check the global/ungrouped shortcuts if still not found
                    if (!rootScEntry) {
                        const globalRootScSet = rootScDataSets.get("");
                        if (globalRootScSet) {
                            rootScEntry = checkShortcut(videoFile.name, globalRootScSet);
                        }
                    }
                    
                    const hasRootSc = rootScEntry !== false;

                    if (isShortcutsOnly) {
                        if (currentMode === 'root-sc') {
                            if (!hasRootSc) continue;
                        } else if (hasAnyShortcuts) {
                            if (!hasProjectSc && !hasRootSc) continue;
                        }
                    }

                    if (isNewOnly && mostRecentShortcutTime && videoFile.lastModified <= mostRecentShortcutTime) {
                        continue;
                    }

                    const files = groupedFiles[videoName].sort((a, b) => {
                        const aNum = parseInt(a.name.substring(a.name.lastIndexOf('_') + 1));
                        const bNum = parseInt(b.name.substring(b.name.lastIndexOf('_') + 1));
                        return aNum - bNum;
                    });

                    const rowDiv = document.createElement('div');
                    rowDiv.className = 'landscape-row';
                    rowDiv.dataset.videoName = videoName;
                    rowDiv.dataset.projectPath = project.path;

                    // Debug log for both-sc detection
                    if (hasProjectSc || hasRootSc) {
                        console.log(`[SC Match] Video: ${videoFile.name}, Subfolder: ${hasProjectSc}, Root: ${hasRootSc}`);
                    }

                    projectRows.push({ rowDiv, videoFile, files, initialShortcutType: '', hasProjectSc, hasRootSc, rootScEntry });
                }

                if (projectRows.length === 0) {
                    continue;
                }

                const header = document.createElement('h2');
                header.className = 'project-header';
                const headerText = document.createElement('span');
                const projectPrefix = (currentMode === 'root-sc' || currentMode === 'sc') ? 'Root Shortcuts: ' : '';
                headerText.textContent = `${projectPrefix}${project.name} (${projectRows.length} ${projectRows.length === 1 ? 'video' : 'videos'})`;
                header.appendChild(headerText);

                if (isNewOnly) {
                    const headerDateInfo = document.createElement('span');
                    headerDateInfo.className = 'date-info';
                    headerDateInfo.textContent = `Last Shortcut: ${new Date(mostRecentShortcutTime).toLocaleString()}`;
                    header.appendChild(headerDateInfo);
                }
                canvasElements.push(header);

                for (const rowData of projectRows) {
                    const { rowDiv, videoFile, files, hasProjectSc, hasRootSc, rootScEntry } = rowData;
                    const dateInfo = document.createElement('div');
                    dateInfo.className = 'date-info';
                    dateInfo.textContent = `Created: ${new Date(videoFile.lastModified).toLocaleString()}`;
                    rowDiv.appendChild(dateInfo);

                    const thumbnailsContainer = document.createElement('div');
                    thumbnailsContainer.className = 'thumbnails-container';
                    rowDiv.appendChild(thumbnailsContainer);

                    if (hasProjectSc) console.log(`Match found in project scdata for: ${videoFile.name}`);
                    if (hasRootSc) console.log(`Match found in root scdata for: ${videoFile.name}`);

                    let initialShortcutType = '';
                    if (rootScEntry && typeof rootScEntry === 'string') {
                        if (rootScEntry === 'BOTH') initialShortcutType = 'both-sc';
                        else if (rootScEntry === 'ROOT') initialShortcutType = 'root-sc';
                    }
                    
                    if (!initialShortcutType) {
                        if (hasProjectSc && hasRootSc) initialShortcutType = 'both-sc';
                        else if (hasProjectSc) initialShortcutType = 'subfolder-sc';
                        else if (hasRootSc) initialShortcutType = 'root-sc';
                    }

                    if (initialShortcutType) {
                        const key = project.path + '|' + videoFile.name;
                        const selectionData = { 
                            videoName: videoFile.name, 
                            projectPath: project.path,
                            subfolder: videoFile.subfolder,
                            type: initialShortcutType
                        };
                        shortcutSelections.set(key, selectionData);
                        initialShortcutSelections.set(key, { type: initialShortcutType });
                    }

                    canvasElements.push(rowDiv);

                    rowDiv.addEventListener('click', () => {
                        const selectionData = {
                            videoName: videoFile.name,
                            projectPath: project.path,
                            subfolder: videoFile.subfolder,
                            type: currentSelectionType
                        };
                        const key = project.path + '|' + videoFile.name;
                        const existingSelection = shortcutSelections.get(key);

                        // Clear previous selection visuals from this row
                        rowDiv.querySelectorAll('.thumbnail').forEach(t => {
                            t.classList.remove('selected-root-sc', 'selected-subfolder-sc', 'selected-both-sc', 'selected-delete-sc', 'selected-shortcut');
                        });

                        if (existingSelection) {
                            shortcutSelections.delete(key);
                        }

                        // If the new selection is different from the old one, or if there was no old one, add it.
                        if (!existingSelection || existingSelection.type !== currentSelectionType) {
                            rowDiv.querySelectorAll('.thumbnail').forEach(t => t.classList.add('selected-' + currentSelectionType));
                            shortcutSelections.set(key, selectionData);
                        }
                    });

                    files.forEach(file => {
                        const img = new Image();
                        img.className = 'thumbnail';
                        img.dataset.fileName = file.name;
                        if (initialShortcutType) {
                            img.classList.add('selected-' + initialShortcutType);
                        }
                        thumbnailsContainer.appendChild(img);
                        
                        const promise = new Promise((resolve, reject) => {
                            img.onload = () => {
                                img.dataset.originalWidth = img.width;
                                img.dataset.originalHeight = img.height;
                                resolve();
                            };
                            img.onerror = reject;
                        });
                        
                        const url = URL.createObjectURL(file);
                        createdObjectUrls.push(url);
                        img.src = url;
                        allImageLoadPromises.push(promise);
                    });
                }
                 if (projectRows.length > 0) {
                    const hr = document.createElement('hr');
                    canvasElements.push(hr);
                    canvases.set(canvasId, { id: canvasId, name: project.name, elements: canvasElements, path: project.path });
                }
            }
            await Promise.all(allImageLoadPromises);
            if (canvases.size > 0) {
                renderCanvas(canvases.keys().next().value);
            } else {
                populateCanvasDropdown(); // Ensure dropdown is cleared if no projects found
                thumbnailContainer.innerHTML = ''; // Clear display area
            }
        }


        async function renderScNewMode() {
            console.log("--- Starting renderScNewMode (v2) ---");
            thumbnailContainer.innerHTML = '';
            canvases.clear();
            shortcutSelections.clear();
            createdObjectUrls.forEach(URL.revokeObjectURL);
            createdObjectUrls = [];

            try {
                const scnewHandle = await currentDirHandle.getFileHandle('scnew.txt');
                const scnewFile = await scnewHandle.getFile();
                const scnewText = await scnewFile.text();
                const shortcutPaths = scnewText.split('\n').map(line => line.trim()).filter(line => line);

                if (shortcutPaths.length === 0) {
                    thumbnailContainer.innerHTML = '<p style="color: black;">scnew.txt is empty. No new shortcuts to display.</p>';
                    return;
                }
                
                const groupedBySubfolder = new Map();
                for (const path of shortcutPaths) {
                    const parts = path.split('\\');
                    if (parts.length >= 3) {
                        const subfolderName = parts[parts.length - 3];
                        const shortcutFileName = parts[parts.length - 1];
                        
                        if (!groupedBySubfolder.has(subfolderName)) {
                            groupedBySubfolder.set(subfolderName, []);
                        }
                        groupedBySubfolder.get(subfolderName).push(shortcutFileName);
                    }
                }

                const allImageLoadPromises = [];
                for (const [subfolderName, shortcutFileNames] of groupedBySubfolder.entries()) {
                    console.log(`Processing subfolder: ${subfolderName}`);
                    const subfolderHandle = await currentDirHandle.getDirectoryHandle(subfolderName);
                    const editDirHandle = await findDirectoryHandleByName(subfolderHandle, 'Edit Thumbnails');

                    const canvasId = getNextCanvasId();
                    const canvasElements = [];
                    const header = document.createElement('h2');
                    header.className = 'project-header';
                    header.textContent = subfolderName;
                    canvasElements.push(header);

                    let projectVideoCount = 0;

                    for (const shortcutFileName of shortcutFileNames) {
                        const videoBaseName = shortcutFileName.slice(0, -4);
                        const videoNameWithoutExt = videoBaseName.substring(0, videoBaseName.lastIndexOf('.'));

                        const landscapeFiles = [];
                        for await (const entry of editDirHandle.values()) {
                            if (entry.kind === 'file' && entry.name.startsWith(videoNameWithoutExt)) {
                                landscapeFiles.push(await entry.getFile());
                            }
                        }

                        if (landscapeFiles.length > 0) {
                             landscapeFiles.sort((a, b) => {
                                const aNum = parseInt(a.name.substring(a.name.lastIndexOf('_') + 1));
                                const bNum = parseInt(b.name.substring(b.name.lastIndexOf('_') + 1));
                                return aNum - bNum;
                            });

                            let videoDate = 'Unknown';
                            try {
                                for await (const entry of subfolderHandle.values()) {
                                    if (entry.kind === 'file' && entry.name.startsWith(videoBaseName)) {
                                        const file = await entry.getFile();
                                        videoDate = new Date(file.lastModified).toLocaleString();
                                        break;
                                    }
                                }
                            } catch (e) {}

                            const rowDiv = document.createElement('div');
                            rowDiv.className = 'landscape-row';
                            rowDiv.dataset.videoName = videoBaseName;
                            rowDiv.dataset.projectPath = subfolderName;

                            const dateInfo = document.createElement('div');
                            dateInfo.className = 'date-info';
                            dateInfo.textContent = `Created: ${videoDate}`;
                            rowDiv.appendChild(dateInfo);

                            const thumbnailsContainer = document.createElement('div');
                            thumbnailsContainer.className = 'thumbnails-container';
                            rowDiv.appendChild(thumbnailsContainer);

                            canvasElements.push(rowDiv);

                             rowDiv.addEventListener('click', () => {
                                const selectionData = {
                                    videoName: videoBaseName,
                                    projectPath: subfolderName,
                                    type: currentSelectionType
                                };
                                const key = subfolderName + '|' + videoBaseName;
                                const existingSelection = shortcutSelections.get(key);

                                // Clear previous selection visuals from this row
                                rowDiv.querySelectorAll('.thumbnail').forEach(t => {
                                    t.classList.remove('selected-root-sc', 'selected-subfolder-sc', 'selected-both-sc', 'selected-delete-sc', 'selected-shortcut');
                                });

                                if (existingSelection) {
                                    shortcutSelections.delete(key);
                                }

                                if (!existingSelection || existingSelection.type !== currentSelectionType) {
                                    rowDiv.querySelectorAll('.thumbnail').forEach(t => t.classList.add('selected-' + currentSelectionType));
                                    shortcutSelections.set(key, selectionData);
                                }
                            });

                             projectVideoCount++;
                             landscapeFiles.forEach(file => {
                                const img = new Image();
                                img.className = 'thumbnail';
                                img.dataset.fileName = file.name;
                                thumbnailsContainer.appendChild(img);
                                const promise = new Promise((resolve, reject) => {
                                    img.onload = () => {
                                        img.dataset.originalWidth = img.width;
                                        img.dataset.originalHeight = img.height;
                                        resolve();
                                    };
                                    img.onerror = reject;
                                });
                                const url = URL.createObjectURL(file);
                                createdObjectUrls.push(url);
                                img.src = url;
                                allImageLoadPromises.push(promise);
                            });
                        }
                    }
                    header.textContent = `${subfolderName} (${projectVideoCount} ${projectVideoCount === 1 ? 'video' : 'videos'})`;
                     if (canvasElements.length > 1) { // Only add if there are more than just the header
                        canvases.set(canvasId, { id: canvasId, name: subfolderName, elements: canvasElements, path: subfolderName });
                    }
                }

                await Promise.all(allImageLoadPromises);

                if (canvases.size > 0) {
                    renderCanvas(canvases.keys().next().value);
                } else {
                    populateCanvasDropdown();
                    thumbnailContainer.innerHTML = '<p style="color: black;">No new shortcuts found to display.</p>';
                }

            } catch (err) {
                console.error("Caught error in renderScNewMode:", err);
                thumbnailContainer.innerHTML = `<p style="color: red;">Error: Could not read or process scnew.txt. Please ensure the file exists and is correctly formatted.</p><p style="color: red; font-size: 0.8em;">${err.message}</p>`;
            }
        }


        async function renderPlaylistMode() {
            thumbnailContainer.innerHTML = '';
            canvases.clear();
            shortcutSelections.clear();
            createdObjectUrls.forEach(URL.revokeObjectURL);
            createdObjectUrls = [];

            if (!g_rootHandle) {
                if (confirm("Would you like to select the root folder to enable root shortcut detection?")) {
                    try {
                        const rootHandle = await window.showDirectoryPicker();
                        g_rootHandle = rootHandle;
                    } catch (e) {}
                }
            }

            let rootScData = new Map();
            if (g_rootHandle) {
                rootScData = await getRootScData(g_rootHandle);
            }

            const projectFolders = [];
            async function findProjectFolders(dirHandle, currentPath = '') {
                for await (const entry of dirHandle.values()) {
                    if (entry.kind === 'directory') {
                        const newPath = currentPath ? `${currentPath}\\${entry.name}` : entry.name;
                        try {
                            await findDirectoryHandleByName(entry, 'Edit Thumbnails');
                            projectFolders.push({ 
                                handle: entry, 
                                path: newPath, 
                                name: entry.name 
                            });
                        } catch (e) {
                            await findProjectFolders(entry, newPath);
                        }
                    }
                }
            }

            try {
                await findDirectoryHandleByName(currentDirHandle, 'Edit Thumbnails');
                projectFolders.push({ 
                    handle: currentDirHandle, 
                    path: '', 
                    name: currentDirHandle.name
                });
            } catch (e) {
                await findProjectFolders(currentDirHandle);
            }

            if (g_rootHandle) {
                for (const project of projectFolders) {
                    try {
                        const relativePathParts = await g_rootHandle.resolve(project.handle);
                        if (relativePathParts) {
                            project.path = relativePathParts.join('\\');
                        }
                    } catch (e) {
                        console.warn(`Could not resolve path for ${project.name} relative to root.`);
                    }
                }
            }

            projectFolders.sort((a, b) => a.name.localeCompare(b.name));

            if (projectFolders.length === 0) {
                alert('No "Edit Thumbnails" folders found.');
                return;
            }

            const allImageLoadPromises = [];
            const canvasId = getNextCanvasId();
            const canvasElements = [];

            for (const project of projectFolders) {
                try {
                    const projectShortcuts = await getScDataForProject(project.handle);
                    const subfolderScCount = projectShortcuts.size;

                    const normalizedProjectName = normalizeProjectKey(project.name);
                    const normalizedProjectPath = normalizeProjectKey(project.path);
                    
                    // Search in rootScData for a matching key
                    let rootProjectShortcutsMap = new Map();
                    for (let [key, val] of rootScData.entries()) {
                        const normalizedKey = normalizeProjectKey(key);
                        if (normalizedKey === normalizedProjectName || normalizedKey === normalizedProjectPath) {
                            rootProjectShortcutsMap = val;
                            break;
                        }
                    }
                    const rootScCount = rootProjectShortcutsMap.size;

                    const videoFiles = [];
                    async function findVideos(dirHandle, subfolder = '') {
                        for await (const entry of dirHandle.values()) {
                            if (entry.kind === 'file' && entry.name.match(/\.(mp4|avi|mov|mkv)$/i)) {
                                entry.subfolder = subfolder;
                                videoFiles.push(entry);
                            } else if (entry.kind === 'directory' && entry.name.toLowerCase() !== 'edit thumbnails' && entry.name.toLowerCase() !== 'thumbnails' && entry.name.toLowerCase() !== 'sc') {
                                await findVideos(entry, subfolder ? `${subfolder}\\${entry.name}` : entry.name);
                            }
                        }
                    }
                    await findVideos(project.handle);

                    if (videoFiles.length === 0) continue;

                    videoFiles.sort((a, b) => a.name.localeCompare(b.name));
                    
                    let candidateVideos = [];
                    const shortcutNames = new Set();
                    try {
                        const scDirHandle = await project.handle.getDirectoryHandle('sc');
                        for await (const entry of scDirHandle.values()) {
                            if (entry.kind === 'file') {
                                shortcutNames.add(entry.name.toLowerCase());
                            }
                        }
                    } catch (e) {}

                    // Priority 1: Videos with shortcuts
                    for (const v of videoFiles) {
                        if (checkShortcut(v.name, shortcutNames)) {
                            candidateVideos.push(v);
                        }
                    }
                    if (candidateVideos.length > 5) {
                        candidateVideos = candidateVideos.slice(0, 5);
                    }

                    // Priority 2: Other videos (alphabetical)
                    if (candidateVideos.length < 5) {
                        for (const v of videoFiles) {
                            if (!checkShortcut(v.name, shortcutNames)) {
                                if (!candidateVideos.includes(v)) {
                                    candidateVideos.push(v);
                                    if (candidateVideos.length >= 5) break;
                                }
                            }
                        }
                    }

                    const header = document.createElement('h2');
                    header.className = 'project-header';
                    header.textContent = `${project.name} (${rootScCount} root shortcuts | ${subfolderScCount} subfolder shortcuts)`;
                    canvasElements.push(header);

                    const rowDiv = document.createElement('div');
                    rowDiv.className = 'landscape-row';
                    rowDiv.dataset.projectPath = project.path;

                    const navContainer = document.createElement('div');
                    navContainer.className = 'playlist-nav-container';
                    rowDiv.appendChild(navContainer);

                    const prevBtn = document.createElement('button');
                    prevBtn.className = 'playlist-nav-btn';
                    prevBtn.textContent = '';
                    navContainer.appendChild(prevBtn);

                    const nextBtn = document.createElement('button');
                    nextBtn.className = 'playlist-nav-btn';
                    nextBtn.textContent = '';
                    navContainer.appendChild(nextBtn);

                    if (candidateVideos.length <= 1) {
                        navContainer.style.display = 'none';
                    }

                    const dateInfo = document.createElement('div');
                    dateInfo.className = 'date-info';
                    rowDiv.appendChild(dateInfo);

                    const thumbnailsContainer = document.createElement('div');
                    thumbnailsContainer.className = 'thumbnails-container';
                    rowDiv.appendChild(thumbnailsContainer);

                    canvasElements.push(rowDiv);

                    let currentIndex = parseInt(localStorage.getItem(`playlist-thumb-index-${project.path}`)) || 0;
                    if (currentIndex >= candidateVideos.length) currentIndex = 0;

                    const updateDisplayedVideo = async (index) => {
                        const video = candidateVideos[index];
                        const videoFile = await video.getFile();
                        dateInfo.textContent = `Created: ${new Date(videoFile.lastModified).toLocaleString()}`;
                        
                        const videoBaseName = video.name.substring(0, video.name.lastIndexOf('.'));
                        const editDirHandle = await findDirectoryHandleByName(project.handle, 'Edit Thumbnails');
                        const thumbnailFiles = [];
                        for await (const entry of editDirHandle.values()) {
                            if (entry.kind === 'file' && entry.name.startsWith(videoBaseName)) {
                                thumbnailFiles.push(await entry.getFile());
                            }
                        }

                        thumbnailFiles.sort((a, b) => {
                            const aNum = parseInt(a.name.substring(a.name.lastIndexOf('_') + 1));
                            const bNum = parseInt(b.name.substring(b.name.lastIndexOf('_') + 1));
                            return aNum - bNum;
                        });

                        thumbnailsContainer.innerHTML = '';
                        const selectionKey = project.path + '|playlist_entry';
                        const existingSelection = shortcutSelections.get(selectionKey);

                        thumbnailFiles.forEach(file => {
                            const img = new Image();
                            img.className = 'thumbnail';
                            img.dataset.projectPath = project.path;
                            if (existingSelection) {
                                img.classList.add('selected-' + existingSelection.type);
                            }
                            thumbnailsContainer.appendChild(img);

                            img.onload = () => {
                                img.dataset.originalWidth = img.width;
                                img.dataset.originalHeight = img.height;
                                layoutLandscapeThumbnails();
                            };

                            const url = URL.createObjectURL(file);
                            createdObjectUrls.push(url);
                            img.src = url;
                        });
                        localStorage.setItem(`playlist-thumb-index-${project.path}`, index);
                    };

                    await updateDisplayedVideo(currentIndex);

                    prevBtn.onclick = (e) => {
                        e.stopPropagation();
                        currentIndex = (currentIndex - 1 + candidateVideos.length) % candidateVideos.length;
                        updateDisplayedVideo(currentIndex);
                    };

                    nextBtn.onclick = (e) => {
                        e.stopPropagation();
                        currentIndex = (currentIndex + 1) % candidateVideos.length;
                        updateDisplayedVideo(currentIndex);
                    };

                    rowDiv.addEventListener('click', () => {
                        const selectionData = { projectPath: project.path, type: currentSelectionType };
                        const key = project.path + '|playlist_entry';
                        const existingSelection = shortcutSelections.get(key);

                        const allThumbnailsInRow = rowDiv.querySelectorAll('.thumbnail');
                        allThumbnailsInRow.forEach(t => t.classList.remove('selected-root-sc', 'selected-subfolder-sc', 'selected-both-sc'));
                        
                        if (existingSelection) {
                            shortcutSelections.delete(key);
                        }

                        if (!existingSelection || existingSelection.type !== currentSelectionType) {
                            allThumbnailsInRow.forEach(t => t.classList.add('selected-' + currentSelectionType));
                            shortcutSelections.set(key, selectionData);
                        }
                    });

                } catch (e) {
                    console.warn(`Could not process project '${project.name}' for playlist mode:`, e);
                }
            }
            
            canvases.set(canvasId, { id: canvasId, name: 'Playlist View', elements: canvasElements, path: '' });
            await Promise.all(allImageLoadPromises);
            renderCanvas(canvasId);
        }

        function generatePlaylistScript() {
            let scriptLines = [
                '$PSScriptRoot = Split-Path -Parent -Path $MyInvocation.MyCommand.Definition',
                '$playlistContent = New-Object System.Collections.Generic.List[string]',
                '$wshell = New-Object -ComObject WScript.Shell',
                "$rootScFolder = [System.IO.Path]::GetFullPath((Join-Path -Path $PSScriptRoot -ChildPath 'sc'))",
                '',
                'function Get-ShortcutTarget {',
                '    param([string]$path)',
                '    try {',
                '        $shortcut = $wshell.CreateShortcut($path)',
                '        $target = $shortcut.TargetPath',
                '        if (-not [System.IO.Path]::IsPathRooted($target)) {',
                '            $target = [System.IO.Path]::GetFullPath((Join-Path -Path (Split-Path -Parent $path) -ChildPath $target))',
                '        } else {',
                '            $target = [System.IO.Path]::GetFullPath($target)',
                '        }',
                '        return $target',
                '    } catch {',
                '        return $null',
                '    }',
                '}',
                ''
            ];

            const selections = Array.from(shortcutSelections.values());
            const rootScSelections = selections.filter(s => s.type === 'root-sc' || s.type === 'both-sc');
            const subfolderScSelections = selections.filter(s => s.type === 'subfolder-sc' || s.type === 'both-sc');

            if (rootScSelections.length > 0) {
                scriptLines.push("# --- Processing Root SC Selections ---");
                scriptLines.push(`if (Test-Path -LiteralPath $rootScFolder) {`);
                scriptLines.push(`    $shortcuts = Get-ChildItem -LiteralPath $rootScFolder -File | Where-Object { $_.Extension -match '^\\.(lnk|ink)$' }`);
                scriptLines.push(`    foreach ($shortcutFile in $shortcuts) {`);
                scriptLines.push(`        $targetPath = Get-ShortcutTarget $shortcutFile.FullName`);
                scriptLines.push('        if (-not $targetPath) { Write-Host "Skipping unresolvable shortcut: $($shortcutFile.Name)" -ForegroundColor Yellow; continue }');
                
                rootScSelections.forEach(sel => {
                    const escapedProjectPath = escapePSString(sel.projectPath);
                    scriptLines.push(`        $projectCheckPath = [System.IO.Path]::GetFullPath((Join-Path -Path $PSScriptRoot -ChildPath '${escapedProjectPath}'))`);
                    scriptLines.push(`        if ($targetPath.StartsWith($projectCheckPath + [IO.Path]::DirectorySeparatorChar, [System.StringComparison]::OrdinalIgnoreCase) -or $targetPath -eq $projectCheckPath) {`);
                    scriptLines.push(`            if ($playlistContent -notcontains $targetPath) {`);
                    scriptLines.push(`                $playlistContent.Add($targetPath)`);
                    scriptLines.push(`                Write-Host "Added to playlist (root): $($shortcutFile.Name)"`);
                    scriptLines.push(`            } else { Write-Host "Skipping duplicate target from root: $($shortcutFile.Name)" -ForegroundColor DarkGray }`);
                    scriptLines.push(`        }`);
                });

                scriptLines.push(`    }`);
                scriptLines.push(`}`);
                scriptLines.push('');
            }

            if (subfolderScSelections.length > 0) {
                scriptLines.push("# --- Processing Subfolder SC Selections ---");
                subfolderScSelections.forEach(sel => {
                    const escapedProjectPath = escapePSString(sel.projectPath);
                    let projectPathVar = `$PSScriptRoot`;
                    if (sel.projectPath) {
                        projectPathVar = `Join-Path -Path $PSScriptRoot -ChildPath '${escapedProjectPath}'`;
                    }
                    scriptLines.push(`    $projectPath = [System.IO.Path]::GetFullPath((${projectPathVar}))`);
                    scriptLines.push(`    if (Test-Path -LiteralPath $projectPath) {`);
                    scriptLines.push(`        $projectShortcuts = Get-ChildItem -LiteralPath $projectPath -Recurse -File | Where-Object { $_.Extension -match '^\\.(lnk|ink)$' -and -not $_.FullName.StartsWith($rootScFolder + [IO.Path]::DirectorySeparatorChar, [System.StringComparison]::OrdinalIgnoreCase) }`);
                    scriptLines.push(`        foreach ($shortcutFile in $projectShortcuts) {`);
                    scriptLines.push(`            $targetPath = Get-ShortcutTarget $shortcutFile.FullName`);
                    scriptLines.push('            if (-not $targetPath) { Write-Host "Skipping unresolvable shortcut: $($shortcutFile.Name)" -ForegroundColor Yellow; continue }');
                    scriptLines.push(`            if ($playlistContent -notcontains $targetPath) {`);
                    scriptLines.push(`                $playlistContent.Add($targetPath)`);
                    scriptLines.push(`                Write-Host "Added to playlist (subfolder): $($shortcutFile.Name)"`);
                    scriptLines.push(`            } else { Write-Host "Skipping duplicate target from subfolder: $($shortcutFile.Name)" -ForegroundColor DarkGray }`);
                    scriptLines.push(`        }`);
                    scriptLines.push(`    }`);
                });
                scriptLines.push('');
            }

            scriptLines.push(`$playlistPath = Join-Path -Path $PSScriptRoot -ChildPath "playlist.m3u"`);
            scriptLines.push(`$playlistContent | Out-File -FilePath $playlistPath -Encoding utf8`);
            scriptLines.push(`Write-Host "Playlist created at: $playlistPath"`);
            scriptLines.push(`Write-Host "Total items in playlist: $($playlistContent.Count)"`);
            scriptLines.push('Read-Host -Prompt "Press Enter to exit"');

            const script = scriptLines.join('\r\n');
            batchScriptTextArea.value = script;
            const blob = new Blob([script], { type: 'text/plain;charset=utf-8' });
            downloadScriptLink.href = URL.createObjectURL(blob);
            downloadScriptLink.download = 'create_playlist.ps1';
        }



        function parseRootScData(scdataText) {
            const lines = scdataText.split('\n').map(line => line.trim()).filter(line => line);
            const data = new Map();
            let currentSubfolder = ""; // Use empty string for flat/ungrouped shortcuts

            for (let line of lines) {
                // In root scdata.txt/rootdata.txt, project headers are often quoted.
                const isQuoted = (line.startsWith('"') && line.endsWith('"')) || (line.startsWith("'") && line.endsWith("'"));
                const cleanLine = line.replace(/^["']|["']$/g, '').trim();
                
                let entry = cleanLine;
                let tag = "";
                if (cleanLine.endsWith('[BOTH]')) {
                    tag = "BOTH";
                    entry = cleanLine.substring(0, cleanLine.length - 6).trim();
                } else if (cleanLine.endsWith('[ROOT]')) {
                    tag = "ROOT";
                    entry = cleanLine.substring(0, cleanLine.length - 6).trim();
                }
                
                const isShortcut = entry.toLowerCase().endsWith('.lnk') || entry.toLowerCase().endsWith('.ink') || entry.toLowerCase().endsWith(' - shortcut.lnk');
                const isVideo = entry.toLowerCase().match(/\.(mp4|mkv|avi|mov|wmv|flv|webm|m4v|mpg|mpeg)$/i);

                if (isQuoted || (!isShortcut && !isVideo && !entry.includes('.') && entry.length > 0)) {
                    // It's a project name
                    currentSubfolder = normalizeProjectKey(cleanLine);
                    if (currentSubfolder && !data.has(currentSubfolder)) {
                        data.set(currentSubfolder, new Map());
                    }
                } else if (entry.length > 0) {
                    // If no currentSubfolder has been identified yet, it belongs to the "" key
                    if (!data.has(currentSubfolder)) {
                        data.set(currentSubfolder, new Map());
                    }
                    data.get(currentSubfolder).set(entry.toLowerCase(), tag);
                }
            }
            return data;
        }

        init();

    </script>
</body>
</html>
